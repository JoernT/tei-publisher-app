<dom-module id="tei-model">
    <template>
        <style is="custom-style">
            .removeIcon {
                --iron-icon-fill-color: var(--paper-blue-grey-700);

                position: absolute;
                right: 5px;
                --iron-icon-width: 48px;
                --iron-icon-height: 48px;
                width: 48px;
                height: 48px;
                display: inline-block;
                top: 0px;
                @apply(--paper-font-common-base);

            }
        </style>
        <style include="publisher-styles">
            :host {
                display: block;
                /*width: 100%;*/
                background: var(--paper-blue-grey-100);
                margin-bottom: 10px;
                position: relative;
                box-shadow: 0 4px 5px 0 rgba(0, 0, 0, 0.14),
                0 1px 10px 0 rgba(0, 0, 0, 0.12),
                0 2px 4px -1px rgba(0, 0, 0, 0.4);
            }

            :host:before {
                content: 'model';
                position: absolute;
                background: var(--paper-blue-grey-600);
                color: var(--paper-blue-grey-100);
                margin: 0 auto;
                right: 70px;
                padding: 2px 12px;
                border-bottom-left-radius: 6px;
                border-bottom-right-radius: 6px;
                border: 1px inset var(--paper-blue-grey-200);
                font-size: small;
            }

            .label {
                font-size: 20px;
                /*font-weight: 300;*/
            }

            .predicate {
                font-weight: 700;
                display: inline-block;
            }

            /*
                        [icon="remove-circle"]{
                            --iron-icon-fill-color: var(--paper-red-300);

                            position: absolute;
                            right: 20px;
                            --iron-icon-width: 48px;
                            --iron-icon-height: 48px;
                        }
            */
            /*
                        [icon="remove-circle"] iron-icon{
                            --iron-icon-width: 100%;
                            --iron-icon-height: 100%;
                        }
            */

            .toggleBar {
                background: var(--paper-blue-grey-50);
                background: var(--paper-blue-grey-300);
                color: white;
                padding: 2px;
            }

            .collapse-content {
                padding: 20px;
                background: white;
            }

            .label {
                min-height: 20px;
            }

            .moreMenu {
                position: absolute;
                right: 10px;
                top: -5px;
            }

            .wrapRendition {
                position: relative;
                border: 1px solid var(--paper-blue-grey-100);
            }

            .wrapRendition [icon="add"] {
                position: absolute;
                top: 4px;
                right: 10px;
            }

            #output, #behaviour {
                display: table-cell;
                padding-right: 10px;
            }

            paper-checkbox {
                display: block;
                margin-left: 10px;
                margin-top: 10px;
            }
        </style>

        <div id="toggle" class="toggleBar" on-click="toggle" aria-expanded$="[[opened]]" aria-controls="collapse"
             tabindex="0">
            <paper-icon-button id="toggleBtn" icon="unfold-more" tabindex="0"></paper-icon-button>
            <span class="label">[[predicateLabel]]</span>
            <!--<span class="predicate">[[predicate]]</span>-->
            <paper-menu-button class="moreMenu" close-on-activate horizontal-align="right" tabindex="0"
                               on-click="_openMenu">
                <paper-icon-button icon="more-vert" mini slot="dropdown-trigger"></paper-icon-button>
                <paper-listbox slot="dropdown-content">
                    <paper-item id="moveUp" on-click="_moveUp">move up</paper-item>
                    <paper-item id="moveDown" on-click="moveDown">move down</paper-item>
                    <paper-item id="delete" on-click="_dispatchRemove">remove this model</paper-item>
                </paper-listbox>
            </paper-menu-button>
        </div>
        <!--
                <paper-icon-button class="removeIcon" icon="remove-circle"
                                   on-click="_dispatchRemove"></paper-icon-button>
        -->

        <iron-collapse id="collapse">
            <div class="collapse-content">
                <div class="wrapper">
                    <slot name="description"></slot>
                    <div class="row">
                        <paper-dropdown-menu id="output" label="output" noink no-animation>
                            <paper-listbox slot="dropdown-content" attr-for-selected="item" selected="{{output}}">
                                <paper-item item=""></paper-item>
                                <paper-item item="web">web</paper-item>
                                <paper-item item="print">print</paper-item>
                                <paper-item item="epub">epub</paper-item>
                                <paper-item item="fo">fo</paper-item>
                                <paper-item item="latex">latex</paper-item>
                                <paper-item item="plain">plain</paper-item>
                            </paper-listbox>
                        </paper-dropdown-menu>
                        <paper-dropdown-menu id="behaviour" label="behaviour" noink no-animation>
                            <paper-listbox slot="dropdown-content" attr-for-selected="item" selected="{{behaviour}}">
                                <paper-item item=""></paper-item>
                                <paper-item item="block">block</paper-item>
                                <paper-item item="inline">inline</paper-item>
                                <paper-item item="alternate">alternate</paper-item>
                                <paper-item item="anchor">anchor</paper-item>
                                <paper-item item="block">block</paper-item>
                                <paper-item item="body">body</paper-item>
                                <paper-item item="break">break</paper-item>
                                <paper-item item="cell">cell</paper-item>
                                <paper-item item="cit">cit</paper-item>
                                <paper-item item="document">document</paper-item>
                                <paper-item item="figure">figure</paper-item>
                                <paper-item item="graphic">graphic</paper-item>
                                <paper-item item="heading">heading</paper-item>
                                <paper-item item="inline">inline</paper-item>
                                <paper-item item="link">link</paper-item>
                                <paper-item item="list">list</paper-item>
                                <paper-item item="listItem">listItem</paper-item>
                                <paper-item item="metadata">metadata</paper-item>
                                <paper-item item="note">note</paper-item>
                                <paper-item item="omit">omit</paper-item>
                                <paper-item item="paragraph">paragraph</paper-item>
                                <paper-item item="row">row</paper-item>
                                <paper-item item="section">section</paper-item>
                                <paper-item item="table">table</paper-item>
                                <paper-item item="text">text</paper-item>
                                <paper-item item="title">title</paper-item>
                            </paper-listbox>
                        </paper-dropdown-menu>
                    </div>

                    <paper-input id="predicate" label="predicate" value="{{predicate}}" title="predicate"></paper-input>
                    <paper-input id="cssClass" label="cssClass" value="{{cssClass}}" title="cssClass"></paper-input>
                    <slot name="parameters"></slot>

                    <div class="wrapRendition">
                        <div class="header2">Renditions</div>
                        <slot name="output-rendition"></slot>
                        <paper-fab icon="add" mini on-click="_addEntry"></paper-fab>
                    </div>

                    <paper-checkbox id="useSourceRendition" title="useSourceRendition">
                        useSourceRendition
                    </paper-checkbox>


    </template>
    <script>
        class TeiModel extends Polymer.Element {
            static get is() {
                return 'tei-model';
            }

            static get properties() {
                return {
                    output: {
                        type: String,
                        reflectToAttribute: true
                    },
                    behaviour: {
                        type: String,
                        reflectToAttribute: true
                    },
                    predicate: {
                        type: String,
                        reflectToAttribute: true,
                        value: ''
                    },
                    cssClass: {
                        type: String,
                        reflectToAttribute: true
                    },
                    useSourceRendition: {
                        type: Boolean,
                        reflectToAttribute: true
                    },
                    opened: {
                        type: Boolean,
                        reflectToAttribute: true
                    },
                    predicateLabel: {
                        type: String,
                        computed: 'computeLabel(predicate)'
                    }
                }
            }

            constructor() {
                super();
                console.log("TeiModel constructor...")
            }

            connectedCallback() {
                super.connectedCallback();
                console.log("TeiModel connected");
                this.setAttribute("slot", "model");
//                document.addEventListener('removeEntry', e => this._removeEntry(e));
//                this.createSlotElements();
                this.tabindex = 0;
                if(this.useSourceRendition === true){
                    this.$.useSourceRendition.setAttribute("checked","true")
                }else{
                    this.$.useSourceRendition.removeAttribute("checked");
                }
            }

            createSlotElements() {
                var slots = this.shadowRoot.querySelectorAll("slot")
                console.log("slots ", slots);
                for (var i = 0, len = slots.length; i < len; i++) {
                    console.log("slot: ", slots[i].assignedNodes());
                    if (slots[i].assignedNodes().length == 0) {
                        var slot = slots[i].name
                        console.log("slot has no content - creating ", slot);
                        var e = document.createElement('tei-' + slot)
                        e.setAttribute("slot", slot)
                        this.appendChild(e);
                    }
                }
            }

            _showEmptySlots(e) {
                this.createSlotElements();
            }

            _setPreferred(e) {
                this.$.star.icon = "star";
            }


            _dispatchRemove(e) {
                console.log("tei-model delete");
                if (confirm("really delete?")) {
                    document.dispatchEvent(new CustomEvent('removeEntry', {detail: {entry: this}}));
                }
            }

            _addEntry() {
                console.log("adding new tei-output-rendition");
                const newEntry = document.createElement("tei-output-rendition")
                newEntry.setAttribute("slot", "output-rendition");
                this.appendChild(newEntry);
                newEntry.createSlotElements();
            }


            _valueChanged(val) {
                console.log("newVal: ", val);
                this.value = val;
                this.innerHTML = val;
            }

            _log(e) {
                //todo: wrap with this element itself
                console.log("output: ", this.innerHTML);
            }

            toggle(e) {

                console.log("toggle ", e);

                this.$.collapse.toggle();
                if (this.$.collapse.opened) {
                    this.$.toggleBtn.icon = 'unfold-less';
                } else {
                    this.$.toggleBtn.icon = 'unfold-more';
                }
            }

            _openMenu(e) {
                console.log('openMenu ', e)
                e.preventDefault();
                e.stopPropagation();
            }

            _moveUp(e) {
                console.log('moveUp ', e)
                //todo
            }

            _moveDown() {
                //todo
            }

            computeLabel(predicate) {
                console.log('computeLabel ', predicate)
                if (predicate == '') {
                    return 'DEFAULT';
                } else {
                    return this.predicate;
                }
            }

        }

        customElements.define(TeiModel.is, TeiModel);
    </script>
</dom-module>

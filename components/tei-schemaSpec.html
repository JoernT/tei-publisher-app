<link rel="import" href="bower_components/polymer/polymer.html">
<link rel="import" href="bower_components/iron-icons/iron-icons.html">
<link rel="import" href="bower_components/paper-fab/paper-fab.html">
<link rel="import" href="bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="bower_components/paper-input/paper-input.html">
<link rel="import" href="bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="bower_components/paper-item/paper-item.html">
<link rel="import" href="bower_components/paper-styles/color.html">
<link rel="import" href="bower_components/paper-styles/shadow.html">


<link rel="import" href="tei-elementSpec.html">

<!--
`tei-schemaSpec`
a wrapper element for ODD rules

@demo demo/index.html 
-->

<dom-module id="tei-schemaSpec">
    <template strip-whitespace>
        <style>
            :host {
                display: block;
                position: relative;
                margin-top:50px;
                border:1px solid #ddd;
                padding: 30px 10px;
                position: relative;
                min-height: 50px;


                @apply(--shadow-elevation-2dp);
            }

            :host:before{
                content:'schemaspec';
                position: absolute;
                top:0;
                left: 0;
                background: var(--paper-light-blue-700);
                color:white;
                padding: 2px 6px;
                font-size: 12px;
                font-style: italic;
                border-bottom-right-radius: 4px;
                font-weight: 300;

            }

            paper-fab {
                position: absolute;
                bottom: -28px;
                right: 17px;
                z-index: 10;

                background: var(--google-blue-700);
            }
            table td{
                vertical-align: top;
                padding:20px;
            }
            tr:nth-child(1) td{
                font-size:24px;
                color:#999;
            }
            tr:nth-child(2) td:nth-child(1){
                border-right:1px solid #ddd;
                position: relative;
            }
            tr:nth-child(2) td:nth-child(1) paper-input{
                margin-right: 20px ;
            }
            tr:nth-child(2) td:nth-child(1):after{
                content:'or';
                position: absolute;
                right: -10px;
                top: 52px;
                background: white;
                font-size:24px;
                background: white;
                color:#ddd;
            }
            table tr:nth-child(2) td:nth-child(2){
                padding-top:41px;
            }
            table tr:nth-child(2) td:nth-child(2) paper-dropdown-menu{
                margin-left:20px;
            }

        </style>
        <content></content>
        <paper-fab id="addSpec" icon="add"></paper-fab>
        <paper-dialog id="dialog">
            <table>
                <tr>
                    <td>Add</td>
                    <td>Change</td>
                </tr>
                <tr>
                    <td>
                        <paper-input id="newElement" label="new element rule..."></paper-input>
                    </td>
                    <td>
                        <paper-dropdown-menu id="changeElement" label="select rule to change..." no-label-float tabindex="-1">
                            <!--<paper-listbox class="dropdown-content" id="langs" on-iron-value="_onListChange" attrForSelected="{{value}}">-->
                            <paper-listbox class="dropdown-content" id="rules" selected="{{value}}">
                                <paper-item></paper-item>
                                <paper-item>div</paper-item>
                                <paper-item>section</paper-item>
                                <paper-item>p</paper-item>
                            </paper-listbox>
                        </paper-dropdown-menu>

                    </td>
                </tr>
            </table>
        </paper-dialog>

    </template>

    <script>
        Polymer({

            is: 'tei-schemaSpec',

            properties: {},

            listeners: {
//                'addSpec.tap': 'addOrChangeElementSpec'
            },

            attached: function (){
                this.listen(this.$.addSpec,'tap','addOrChangeElementSpec');
//                this.listen(this.$.newElement,'blur','handleNew');
                this.listen(this.$.newElement,'keydown','handleNew');
                this.addEventListener('deleteElementSpec', this._deleteElementSpec);

                this.listen(this.$.rules,'iron-select','handleChange');
            },
            detached: function () {
                this.unlisten(this.$.addSpec,'tap','addOrChangeElementSpec');
//                this.unlisten(this.$.newElement,'blur', 'handleNew');
                this.unlisten(this.$.newElement,'keydown','handleNew');
                this.unlisten(this.$.rules,'iron-select','handleChange');


            },

            addOrChangeElementSpec: function (e) {

                this.$.newElement.value="";
                this.$.rules.selected=0;
                this.$.dialog.open();
                e.stopPropagation();
            },

            handleNew: function (e) {
                console.log(e)


                if (e.keyCode === 13) {
                    //success
                    this.$.dialog.close();

                    this._appendNewElementSpec(this.$.newElement.value, 'add');
//                    console.log("new element name", this.$.newElement.value)
//                    var newSpec = document.createElement('tei-elementSpec');
//                    newSpec.mode='add';
//
//                    //todo: check if not present already
//                    newSpec.ident=this.$.newElement.value;
//                    this.appendChild(newSpec);

                }

            },

            handleChange: function (e) {
                //tbd
                console.log("changed",e.detail.item.innerText.trim())
                var item = e.detail.item.innerText.trim();
                if (item !== ''){
                    this.$.dialog.close();
                    this._appendNewElementSpec(item,'change')
                }
            },

            _deleteElementSpec: function (e) {
                var elem = e.target;
                //todo - ask back
                var r = confirm('really delete?');
                if(r){
                    this.removeChild(elem);
                }
            },

            _appendNewElementSpec: function (value, mode) {
                var newSpec = document.createElement('tei-elementSpec');
                newSpec.mode=mode;
                newSpec.ident=value;
                this.appendChild(newSpec);
            }


        });
    </script>
</dom-module>
